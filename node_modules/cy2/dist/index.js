var ft=Object.create;var N=Object.defineProperty;var lt=Object.getOwnPropertyDescriptor;var ht=Object.getOwnPropertyNames;var mt=Object.getPrototypeOf,gt=Object.prototype.hasOwnProperty;var ie=(e,t)=>()=>(e&&(t=e(e=0)),t);var R=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),V=(e,t)=>{for(var r in t)N(e,r,{get:t[r],enumerable:!0})},ae=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of ht(t))!gt.call(e,o)&&o!==r&&N(e,o,{get:()=>t[o],enumerable:!(n=lt(t,o))||n.enumerable});return e};var m=(e,t,r)=>(r=e!=null?ft(mt(e)):{},ae(t||!e||!e.__esModule?N(r,"default",{value:e,enumerable:!0}):r,e)),X=e=>ae(N({},"__esModule",{value:!0}),e);var pe={};V(pe,{error:()=>G,warn:()=>O});var _,W,O,G,B=ie(()=>{_=m(require("chalk")),W=m(require("util")),O=(...e)=>console.warn(_.default.bgYellow.black(`
 WARNING `),W.default.format(...e),`
`),G=(...e)=>console.warn(_.default.bgRed.black(`
 ERROR `),W.default.format(...e),`
`)});var le={};V(le,{debugHttpProxy:()=>yt});var fe,yt,he=ie(()=>{fe=require("debug"),yt=(0,fe.debug)("cy2-http-proxy")});var D=R(ge=>{var E=ge,Pt=require("url"),me=require("util")._extend,At=require("requires-port"),Et=/(^|,)\s*upgrade\s*($|,)/i,F=/^https|wss/;E.isSSL=F;E.setupOutgoing=function(e,t,r,n){let o={...t};r.url==="/preflight"&&(o.target=new URL("https://api.cypress.io")),e.port=o[n||"target"].port||(F.test(o[n||"target"].protocol)?443:80),["host","hostname","socketPath","pfx","key","passphrase","cert","ca","ciphers","secureProtocol"].forEach(function(p){e[p]=o[n||"target"][p]}),e.method=o.method||r.method,e.headers=me({},r.headers),o.headers&&me(e.headers,o.headers),o.auth&&(e.auth=o.auth),o.ca&&(e.ca=o.ca),F.test(o[n||"target"].protocol)&&(e.rejectUnauthorized=typeof o.secure>"u"?!0:o.secure),e.agent=o.agent||!1,e.localAddress=o.localAddress,e.agent||(e.headers=e.headers||{},(typeof e.headers.connection!="string"||!Et.test(e.headers.connection))&&(e.headers.connection="close"));var s=o[n||"target"],a=s&&o.prependPath!==!1&&s.path||"",i=o.toProxy?r.url:Pt.parse(r.url).path||"";return i=o.ignorePath?"":i,e.path=E.urlJoin(a,i),o.changeOrigin&&(e.headers.host=At(e.port,o[n||"target"].protocol)&&!Ct(e.host)?e.host+":"+e.port:e.host),e};E.setupSocket=function(e){return e.setTimeout(0),e.setNoDelay(!0),e.setKeepAlive(!0,0),e};E.getPort=function(e){var t=e.headers.host?e.headers.host.match(/:(\d+)/):"";return t?t[1]:E.hasEncryptedConnection(e)?"443":"80"};E.hasEncryptedConnection=function(e){return Boolean(e.connection.encrypted||e.connection.pair)};E.urlJoin=function(){var e=Array.prototype.slice.call(arguments),t=e.length-1,r=e[t],n=r.split("?"),o;return e[t]=n.shift(),o=[e.filter(Boolean).join("/").replace(/\/+/g,"/").replace("http:/","http://").replace("https:/","https://")],o.push.apply(o,n),o.join("?")};E.rewriteCookieProperty=function e(t,r,n){return Array.isArray(t)?t.map(function(o){return e(o,r,n)}):t.replace(new RegExp("(;\\s*"+n+"=)([^;]+)","i"),function(o,s,a){var i;if(a in r)i=r[a];else if("*"in r)i=r["*"];else return o;return i?s+i:""})};function Ct(e){return!!~e.indexOf(":")}});var Ae=R((Jt,Pe)=>{var we=require("url"),ye=D(),vt=/^201|30(1|2|7|8)$/;Pe.exports={removeChunked:function(t,r,n){t.httpVersion==="1.0"&&delete n.headers["transfer-encoding"]},setConnection:function(t,r,n){t.httpVersion==="1.0"?n.headers.connection=t.headers.connection||"close":t.httpVersion!=="2.0"&&!n.headers.connection&&(n.headers.connection=t.headers.connection||"keep-alive")},setRedirectHostRewrite:function(t,r,n,o){if((o.hostRewrite||o.autoRewrite||o.protocolRewrite)&&n.headers.location&&vt.test(n.statusCode)){var s=we.parse(o.target),a=we.parse(n.headers.location);if(s.host!=a.host)return;o.hostRewrite?a.host=o.hostRewrite:o.autoRewrite&&(a.host=t.headers.host),o.protocolRewrite&&(a.protocol=o.protocolRewrite),n.headers.location=a.format()}},writeHeaders:function(t,r,n,o){var s=o.cookieDomainRewrite,a=o.cookiePathRewrite,i=o.preserveHeaderKeyCase,p,g=function(d,f){f!=null&&(s&&d.toLowerCase()==="set-cookie"&&(f=ye.rewriteCookieProperty(f,s,"domain")),a&&d.toLowerCase()==="set-cookie"&&(f=ye.rewriteCookieProperty(f,a,"path")),r.setHeader(String(d).trim(),f))};if(typeof s=="string"&&(s={"*":s}),typeof a=="string"&&(a={"*":a}),i&&n.rawHeaders!=null){p={};for(var u=0;u<n.rawHeaders.length;u+=2){var c=n.rawHeaders[u];p[c.toLowerCase()]=c}}Object.keys(n.headers).forEach(function(d){var f=n.headers[d];i&&p&&(d=p[d]||d),g(d,f)})},writeStatusCode:function(t,r,n){n.statusMessage?(r.statusCode=n.statusCode,r.statusMessage=n.statusMessage):r.statusCode=n.statusCode}}});var Ce=R((qt,Ee)=>{var Tt=require("http"),Rt=require("https"),M=Ae(),L=D(),bt=require("follow-redirects");M=Object.keys(M).map(function(e){return M[e]});var xt={http:Tt,https:Rt};Ee.exports={deleteLength:function(t,r,n){(t.method==="DELETE"||t.method==="OPTIONS")&&!t.headers["content-length"]&&(t.headers["content-length"]="0",delete t.headers["transfer-encoding"])},timeout:function(t,r,n){n.timeout&&t.socket.setTimeout(n.timeout)},XHeaders:function(t,r,n){if(n.xfwd){var o=t.isSpdy||L.hasEncryptedConnection(t),s={for:t.connection.remoteAddress||t.socket.remoteAddress,port:L.getPort(t),proto:o?"https":"http"};["for","port","proto"].forEach(function(a){t.headers["x-forwarded-"+a]=(t.headers["x-forwarded-"+a]||"")+(t.headers["x-forwarded-"+a]?",":"")+s[a]}),t.headers["x-forwarded-host"]=t.headers["x-forwarded-host"]||t.headers.host||""}},stream:function(t,r,n,o,s,a){let i={...n};t.url==="/preflight"&&(i.target=new URL("https://api.cypress.io")),s.emit("start",t,r,i.target||i.forward);var p=i.followRedirects?bt:xt,g=p.http,u=p.https;if(i.forward){var c=(i.forward.protocol==="https:"?u:g).request(L.setupOutgoing(i.ssl||{},i,t,"forward")),d=S(c,i.forward);if(t.on("error",d),c.on("error",d),(i.buffer||t).pipe(c),!i.target)return r.end()}var f=(i.target.protocol==="https:"?u:g).request(L.setupOutgoing(i.ssl||{},i,t));f.on("socket",function(A){s&&!f.getHeader("expect")&&s.emit("proxyReq",f,t,r,i)}),i.proxyTimeout&&f.setTimeout(i.proxyTimeout,function(){f.abort()}),t.on("aborted",function(){f.abort()});var v=S(f,i.target);t.on("error",v),f.on("error",v);function S(A,T){return function(H){if(t.socket.destroyed&&H.code==="ECONNRESET")return s.emit("econnreset",H,t,r,T),A.abort();a?a(H,t,r,T):s.emit("error",H,t,r,T)}}(i.buffer||t).pipe(f),f.on("response",function(A){if(s&&s.emit("proxyRes",A,t,r),!r.headersSent&&!i.selfHandleResponse)for(var T=0;T<M.length&&!M[T](t,r,A,i);T++);r.finished?s&&s.emit("end",t,r,A):(A.on("end",function(){s&&s.emit("end",t,r,A)}),i.selfHandleResponse||A.pipe(r))})}}});var Te=R(($t,ve)=>{var St=require("http"),Ot=require("https"),I=D();ve.exports={checkMethodAndHeader:function(t,r){if(t.method!=="GET"||!t.headers.upgrade||t.headers.upgrade.toLowerCase()!=="websocket")return r.destroy(),!0},XHeaders:function(t,r,n){if(n.xfwd){var o={for:t.connection.remoteAddress||t.socket.remoteAddress,port:I.getPort(t),proto:I.hasEncryptedConnection(t)?"wss":"ws"};["for","port","proto"].forEach(function(s){t.headers["x-forwarded-"+s]=(t.headers["x-forwarded-"+s]||"")+(t.headers["x-forwarded-"+s]?",":"")+o[s]})}},stream:function(t,r,n,o,s,a){var i=function(u,c){return Object.keys(c).reduce(function(d,f){var v=c[f];if(!Array.isArray(v))return d.push(f+": "+v),d;for(var S=0;S<v.length;S++)d.push(f+": "+v[S]);return d},[u]).join(`\r
`)+`\r
\r
`};I.setupSocket(r),o&&o.length&&r.unshift(o);var p=(I.isSSL.test(n.target.protocol)?Ot:St).request(I.setupOutgoing(n.ssl||{},n,t));return s&&s.emit("proxyReqWs",p,t,r,n,o),p.on("error",g),p.on("response",function(u){u.upgrade||(r.write(i("HTTP/"+u.httpVersion+" "+u.statusCode+" "+u.statusMessage,u.headers)),u.pipe(r))}),p.on("upgrade",function(u,c,d){c.on("error",g),c.on("end",function(){s.emit("close",u,c,d)}),r.on("error",function(){c.end()}),I.setupSocket(c),d&&d.length&&c.unshift(d),r.write(i("HTTP/1.1 101 Switching Protocols",u.headers)),c.pipe(r).pipe(c),s.emit("open",c),s.emit("proxySocket",c)}),p.end();function g(u){a?a(u,t,r):s.emit("error",u,t,r),r.end()}}}});var Ye=R((er,Me)=>{var{debugHttpProxy:Z}=(he(),X(le)),{error:It}=(B(),X(pe)),{omit:Re,pick:be,isUndefined:Bt}=require("lodash"),Ie=Me.exports,xe=require("util")._extend,Mt=require("url").parse,Be=require("eventemitter3"),Yt=require("http"),Ht=require("https"),Se=Ce(),Oe=Te();Ie.Server=b;function k(e){return function(r){return function(o,s){var a=e==="ws"?this.wsPasses:this.webPasses,i=[].slice.call(arguments),p=i.length-1,g,u;typeof i[p]=="function"&&(u=i[p],p--);var c=r;if(!(i[p]instanceof Buffer)&&i[p]!==s&&(c=xe({},r),xe(c,i[p]),p--),i[p]instanceof Buffer&&(g=i[p]),["target","forward"].forEach(function(f){typeof c[f]=="string"&&(c[f]=Mt(c[f]))}),!c.target&&!c.forward)return this.emit("error",new Error("Must provide a proper URL as target"));Bt(a==null?void 0:a.length)&&(It("Unexpected error processing the request. Please report the issue and the details below. Set environment variable DEBUG=cy2* and rerun to get more information"),console.error("Request: %o",be(o,"httpVersion","method","url","headers","upgrade","aborted","complete")),console.error("Proxy: type %s, request options: %O",e,Re(c,"ssl"))),Z("applying passes, proxy type: %s, request options: %o",e,Re(c,"ssl")),Z("Request: %o",be(o,"httpVersion","method","url","headers","upgrade","aborted","complete"));for(var d=0;d<a.length;d++)if(a[d](o,s,c,g,this,u)){Z('pass halted the loop type "%s", #%d: %s %s',e,d,a[d].name,o.method,o.url);break}}}}Ie.createRightProxy=k;function b(e){Be.call(this),e=e||{},e.prependPath=e.prependPath!==!1,this.web=this.proxyRequest=k("web")(e),this.ws=this.proxyWebsocketRequest=k("ws")(e),this.options=e,this.webPasses=Object.keys(Se).map(function(t){return Se[t]}),this.wsPasses=Object.keys(Oe).map(function(t){return Oe[t]}),this.on("error",this.onError,this)}require("util").inherits(b,Be);b.prototype.onError=function(e){if(this.listeners("error").length===1)throw e};b.prototype.listen=function(e,t,r){var n=this,o=function(s,a){n.web(s,a)};return this._server=this.options.ssl?Ht.createServer(this.options.ssl,o):Yt.createServer(o),this.options.ws&&this._server.on("upgrade",function(s,a,i){n.ws(s,a,i)}),this._server.listen(e,t,r),this};b.prototype.close=function(e){var t=this;this._server&&this._server.close(r);function r(){t._server=null,e&&e.apply(null,arguments)}};b.prototype.before=function(e,t,r){if(e!=="ws"&&e!=="web")throw new Error("type must be `web` or `ws`");var n=e==="ws"?this.wsPasses:this.webPasses,o=!1;if(n.forEach(function(s,a){s.name===t&&(o=a)}),o===!1)throw new Error("No such pass");n.splice(o,0,r)};b.prototype.after=function(e,t,r){if(e!=="ws"&&e!=="web")throw new Error("type must be `web` or `ws`");var n=e==="ws"?this.wsPasses:this.webPasses,o=!1;if(n.forEach(function(s,a){s.name===t&&(o=a)}),o===!1)throw new Error("No such pass");n.splice(o++,0,r)}});var Ne=R((tr,He)=>{var Y=Ye().Server;function J(e){return new Y(e)}Y.createProxyServer=J;Y.createServer=J;Y.createProxy=J;He.exports=Y});var Ue=R((rr,Qe)=>{Qe.exports=Ne()});var Vt={};V(Vt,{getCypressCLIBinPath:()=>U,run:()=>dt,spawn:()=>ut});module.exports=X(Vt);var Or=require("source-map-support/register");var Q=require("path");var j=require("debug"),l=(0,j.debug)("cy2"),h=(0,j.debug)("cy2-net");B();async function U(){var e;if(process.env.CYPRESS_PACKAGE_SHELL_SCRIPT)return l("Cypress binary path from CYPRESS_PACKAGE_SHELL_SCRIPT: %s",process.env.CYPRESS_PACKAGE_SHELL_SCRIPT),process.env.CYPRESS_PACKAGE_SHELL_SCRIPT;try{let t=require.resolve("cypress"),r=require("cypress/package.json");if(!r.bin||!((e=r.bin)!=null&&e.cypress))throw new Error("Cannot detect cypress package executable");let n=(0,Q.resolve)((0,Q.dirname)(t),r.bin.cypress);if(l("Cypress binary path: %s",n),!n)throw new Error("Cannot detect cypress package executable");return n}catch(t){throw G("Cannot detect cypress package executable. Consider using CYPRESS_PACKAGE_SHELL_SCRIPT environment variable. Tried locations: %O",require.resolve.paths("cypress")),t}}var pt=m(require("child_process")),ct=require("os");var K={name:"cy2",version:"4.0.8",author:"Andrew Goldis",main:"./dist",typings:"./dist",license:"GPL-3.0-or-later",repository:{type:"git",url:"https://github.com/sorry-cypress/cy2.git"},scripts:{postinstall:"patch-package",build:"run-p tsc esbuild",dev:"run-p watch:*",test:"jest",tsc:"tsc",esbuild:"node ./build.js","watch:tsc":'run-s "tsc --watch --preserveWatchOutput"',"watch:esbuild":"esbuild ./src/*.ts --bundle --platform=node --target=node14 --packages=external --sourcemap=inline --outdir=dist --watch","build-tunnel":"esbuild ./src/tunnel-proxy.ts --bundle --platform=node --target=node14 --packages=external --sourcemap=inline --outdir=dist",release:"release-it","release-ci":"release-it --ci --npm.skipChecks --no-git --no-github --no-increment --npm.publish",clean:"rimraf dist"},files:["bin/*","dist/index.js*","!dist/__tests__","!dist/*.d.ts","!dist/**/*.d.ts","dist/index.d.ts","dist/cypress-wrapper.d.ts","dist/bin-path.d.ts"],bin:{cy2:"bin/cy2"},engines:{node:">=14.17.0"},keywords:["cypress","sorry-cypress","cypress dashboard","cypress ci","cypress parallel","currents"],dependencies:{chalk:"^4.1.2",eventemitter3:"^4.0.0","follow-redirects":"^1.0.0","fp-ts":"^2.13.1","http-terminator":"^3.2.0","https-proxy-agent":"^5.0.1",lodash:"^4.17.21",micromatch:"^4.0.5","patch-package":"^6.5.1","requires-port":"^1.0.0","source-map-support":"^0.5.21",tmp:"^0.2.1"},devDependencies:{"@release-it/conventional-changelog":"^5.1.1","@types/http-proxy":"^1.17.9","@types/jest":"^27.0.1","@types/lodash":"^4.14.191","@types/micromatch":"^4.0.2","@types/node":"^18.11.17",cypress:">=6.7.0",devcert:"^1.2.2",esbuild:"^0.16.13",jest:"^29.3.1","npm-run-all":"^4.1.5","release-it":"^15.6.0",rimraf:"^3.0.2","ts-jest":"^29.0.3",typescript:"^4.9.4"},"release-it":{npm:{publish:!1},github:{release:!0},plugins:{"@release-it/conventional-changelog":{preset:"angular",header:"# Changelog",ignoreVersion:!0,infile:"CHANGELOG.md"}},git:{commitMessage:"chore: release v${version}"},hooks:{"before:init":"run-s clean build"}},prettier:{singleQuote:!0}};var Ze=m(require("fp-ts/Array")),ke=require("fp-ts/function"),C=m(require("fp-ts/Option")),Je=m(require("http")),qe=require("http-terminator"),$e=require("micromatch");var ce=(e,t="base64")=>Buffer.from(e,t).toString();var De=require("https-proxy-agent");var ue=`-----BEGIN CERTIFICATE-----
MIIEWjCCAkICFDtuRdVQgEMC2Gc8tSvZR97D+bKJMA0GCSqGSIb3DQEBCwUAMHUx
CzAJBgNVBAYTAlVTMQswCQYDVQQIDAJDQTEWMBQGA1UEBwwNU2FuIEZyYW5jaXNj
bzERMA8GA1UECgwISGVsbG9IdWIxFTATBgNVBAsMDEhlbGxvSHViIERldjEXMBUG
A1UEAwwOYXBpLmN5cHJlc3MuaW8wHhcNMjMxMjA4MTIzMDU0WhcNMjgxMjA2MTIz
MDU0WjBeMQswCQYDVQQGEwJBVTETMBEGA1UECAwKU29tZS1TdGF0ZTEhMB8GA1UE
CgwYSW50ZXJuZXQgV2lkZ2l0cyBQdHkgTHRkMRcwFQYDVQQDDA5hcGkuY3lwcmVz
cy5pbzCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALn3KlQp6FQz3QM1
LEsmqYo/qlfAjPfh7IQDkOl7xMfZ809yCIQURbgEWDAnlpQqxVd01gp4F5wd7QUc
JWY1CVMjjJr61WXo8XTaV5hn8c8H1ABETzRYYlkKC+Ht7jtkqKWG6PCI4+YXNgT0
hlmI9NtDHQzzwLrm7GY6eV+AFumTshxrZs/JSuXf3vhCqoMviOtVpD++iMx/q/uD
eVVMSs2aWW47RWKaVNiSrHev6Vf6pcvaqawZ9TJBeD6q8nlgTWL+iMyOS9HGptX7
o6USHaK1j09NrRjbPUMo29m/5mssG7+9+Jjfa+riCIPyfUgZIz/whvmqt7OP442e
OsqynQkCAwEAATANBgkqhkiG9w0BAQsFAAOCAgEAJfBt3FhgSkWFoquy29lZ2kkP
8EAztk4W4OOmKAjvN2aF08rxIaxOiCJaTAVnoG0PbLMDlsj1V2ttUqoD/Cv5gHO2
IajS5LXEcb+ij/HwhYbQg7YKE/xPbjR4oXtBsHiU1f0k6sPBsBHHaTxQ0drO+ItA
LCCMNDX43lVziV46FDgXRnP/YMS8waSmt9up1hKdrBQ537+8J/RtLa7FYoih3E9L
5nA77Y1zWwneRAzW1U7WwTk0iXm6IMd3Y1dSG4jS75o9pAdHvxphXNeZWPgNOw6D
I6dMrRoIKhpQDojS+wczZOljcnw8yYBVSdRaXbqjgl5VV0jAenc91hlFYy4W/lXx
XqklUVUHoXpboPHaad7495/U7l21Ghju5Pd+B5mQPqOrYao3hOtKxFPFbVu4Fol8
HxahKL7WeX2IqON8LTLe/SZPBlIpQV+ODtcszb0CMpAomosdc5Y+IWsg6UtuDB12
m4b/+R+l3bJpcDfX4Qkq3vrYAD0ihr7cMAzZkC20Z1/Svoj5M2iwwxs/Q3n8r5jQ
kaq0rvoyoFfwJ7E39WH05Bu0N04SlbuV+Bmx9bCTbMblKjeTpL5gt5smASnlPj0i
yj6LqpnE9P1lkIn1V4zOWvVmmWASYDIVyA45NA4ZzL+qgvulJAmvELC8UbcviPOr
gCiHabEEIkljimSrSlA=
-----END CERTIFICATE-----`,de=`-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC59ypUKehUM90D
NSxLJqmKP6pXwIz34eyEA5Dpe8TH2fNPcgiEFEW4BFgwJ5aUKsVXdNYKeBecHe0F
HCVmNQlTI4ya+tVl6PF02leYZ/HPB9QARE80WGJZCgvh7e47ZKilhujwiOPmFzYE
9IZZiPTbQx0M88C65uxmOnlfgBbpk7Ica2bPyUrl3974QqqDL4jrVaQ/vojMf6v7
g3lVTErNmlluO0VimlTYkqx3r+lX+qXL2qmsGfUyQXg+qvJ5YE1i/ojMjkvRxqbV
+6OlEh2itY9PTa0Y2z1DKNvZv+ZrLBu/vfiY32vq4giD8n1IGSM/8Ib5qrezj+ON
njrKsp0JAgMBAAECggEAGpf5+ac0jjYMeRT1jJmuzRJlrb7faeNpC0fnRTxp25qT
bN0F0r2DatlUMy62HeIv7l3K7hxWZADzkDOCNaeH+devl8ofEj/Jp8hBlo3mypB4
BMHAAeBR0CHbqSd5Vg0DAQjV7u/kh1byZqsBO3SWb3SdhuikuxWi4Muj58BNhoFV
iVRiwX4oG3eWlI/jd2TOp8ltOwxx/X+YZXyyBiYgW8eaoGpZlRt1wF2sUDvZOu3e
w+kax56J2ViipBKksvUvRF1O7j21T+/X2WShzAIqcpC6CcfKDGNnj2WNJn2NdBWF
1D8uzOoBtfR70w5V1qL2FEuYHptEbiEL+AjhbTo9cQKBgQD6sAhypIqgBZ7nXhi2
ALI64kSccRUSs0vWn291GKOPR+pcLjJNEGrLYBvCxs5BfLjbS9zdyxoa8ARyB1Jl
yc61ISgcp9oBDZI4DWqUshd1PzWr+17yc6n62CuJ9ZDVlIgrRmESVGDRrm/r2aQ7
/dEAa4Kpf/+wIzLzEnct9BvMawKBgQC96ASoninBOvMB+lsfQCkCFRVDj3aEW88K
3knJYGIwtTegYJF+EnUq9sljB02Q8eYTAESiOv64SBIVtkXYQEn3taOikWbycCar
76tNpddoj1YGOR0PiWZ4pPoi6F8IfWbPUchUZo/nRECtVxk9HJas9PGDmiKyhS2S
YJQpoC+ZWwKBgGVV21RcZx0gqIdmZh7MUT+0T3/dxmL0z2dGs8tl1lgI/hedJQA5
7rGffBlUO/QE8sTS+ck+XKMe+u0NQKWc2k4lxQ0wXNOoJL87zSWmiA0BLDUFO/BO
CRw5XgA6n/12OUUlAgBi03BvTxbLt7P4eg/tZbgW4cjVsbbIdBzDXKlZAoGACPH3
3jVtBBQRxEMVrbgo9lcl5EPKsltcukdUNG8c0OyITT6fO9AEwtxTCh4a8jviuXxm
vzmGLAoBCBLI4XHNyiQ9K/grYDoWKD0m1YZ9SgiOZcak7slrET28Jo7Jgy3c/OD+
TbNzDdKyNTgIEU/abRUwlyFYhw4s4ls4P2mzNEcCgYEAlrNQZpCHoHBEKWCk7OFW
BcWoAyWtptVtRVqI7X0MT0MmuHeLir5IR9pKH+2b5edoPINpPjwcfDY8Odm2R2tv
k5k/80o0az9SYGNAufn855OcSYZyzQvf0TIiaN7PVSuO3FQeN/XlUyim7MAUIYgL
mNJpk6MwWyCnRbFLW8iemCY=
-----END PRIVATE KEY-----`,z=process.env.CY2_EMPTY_CA?"":`-----BEGIN CERTIFICATE-----
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
-----END CERTIFICATE-----`;var Le=m(Ue());B();var y=new Map;async function Ve(){h("Stopping interceptors"),await Promise.all(Array.from(y.values()).map((e,t,r)=>new Promise(n=>e.close(()=>{h("Stopped interceptor %d/%d",t+1,r.length),n()})))),y.clear()}async function Xe({target:e,upstreamProxy:t}){if(y.has("upstream"))return h("Using interceptor with upstream routing",t.toString(),e),y.get("upstream");h("Creating interceptor with upstream routing path: %s -> %s",t.toString(),e);let r=new De.HttpsProxyAgent({protocol:t.protocol,host:t.hostname,port:t.port,path:t.pathname});return y.set("upstream",await _e({target:e,agent:r})),y.get("upstream")}async function je({target:e}){return y.has("direct")?(h("Using interceptor with direct routing"),y.get("direct")):(h("Creating interceptor with direct routing path: %s",e),y.set("direct",await _e({target:e})),y.get("direct"))}function _e({target:e,agent:t}){return new Promise(r=>{h("Creating interceptor for %s",e);let n=Le.createProxyServer({target:e,changeOrigin:!0,followRedirects:!0,agent:t,secure:!1,ssl:{key:de,cert:ue}}).on("error",o=>{let s=Boolean(t)?"upstream proxy":"direct";h("Interceptor of type %s error: %s",s,o),O("Error connecting to %s: %s",e,o.message)});n.listen(0,void 0,()=>r(n))})}var q=m(require("net"));function We({socket:e,port:t,hostname:r}){let n=q.default.connect(t,r);n.on("ready",function(){e.pipe(n),n.pipe(e),e.write(`HTTP/1.1 200 OK\r
\r
`)}),n.on("error",function(){n.end(),n.destroy(),e.end(),e.destroy()}),e.on("error",function(){e.end(),e.destroy(),n.end(),n.destroy()})}function Ge({socket:e,port:t}){let r=q.default.connect(t);r.on("ready",()=>{r.pipe(e),e.pipe(r),e.write(`HTTP/1.1 200 OK\r
\r
`)}),r.on("error",()=>{e.end(),e.destroy()}),r.on("end",()=>{e.end(),e.destroy()}),e.on("error",()=>{r.end(),r.destroy()}),e.on("end",()=>{r.end(),r.destroy()})}var Ke=m(require("http")),ze=m(require("https"));function Fe(e,t,r){h("Proxy chain to upstream for",e.url),r.protocol==="https:"?ze.default:Ke.default.request({method:"CONNECT",path:e.url,headers:e.headers,agent:!1,hostname:r.hostname,port:r.port,protocol:r.protocol}).once("upgrade",o).once("connect",s).once("error",a).once("response",n).end();function n(i){i.upgrade=!0}function o(i,p){process.nextTick(function(){s(i,p)})}function s(i,p){p.setNoDelay(!0),p.removeAllListeners(),i.statusCode===200?(t.pipe(p),p.pipe(t),t.write(`HTTP/1.1 200 OK\r
\r
`)):(t.write(`HTTP/1.1 500 SERVER ERROR\r
\r
`),t.end(),t.destroy()),p.on("error",()=>{p.end(),p.destroy(),t.end(),t.destroy()}),t.on("error",()=>{p.end(),p.destroy(),t.end(),t.destroy()})}function a(i){console.error("Upstream proxy connection error",i),t.end(),t.destroy()}}async function $({target:e="https://cy.currents.dev",upstreamProxy:t=null,envVariables:r={}}){return new Promise((n,o)=>{var g;let s=Nt(t,e,(g=r.NO_PROXY)==null?void 0:g.split(",")),a=Je.default.createServer(),i=(0,qe.createHttpTerminator)({server:a});async function p(){h("Stopping proxy"),await i.terminate()}a.on("connect",s).listen(0,()=>{let u=a.address();if(!Dt(u)){o(new Error("Unable to detect proxy address"));return}h("Proxy is listening on port %d",u.port),n({stop:async()=>{await Ve(),await p(),h("Stopped proxy + interceptors")},port:u.port})})})}var Nt=(e,t,r=[])=>function(o,s){if(h("Connection request: %s",o.url),!o.url)throw new Error("Missing req.url in connect handler");let[a,i]=o.url.split(":",2);if(Ut(a)){Qt({target:t,hostname:a,socket:s,upstreamProxy:e,noProxy:r});return}if(e&&et(a,r)){Fe(o,s,e);return}We({socket:s,port:parseInt(i,10),hostname:a})};async function Qt({target:e,hostname:t,socket:r,upstreamProxy:n=null,noProxy:o=[]}){let a=(await(0,ke.pipe)(n,C.fromNullable,C.filter(()=>et(new URL(e).hostname,o)),C.map(i=>Xe({upstreamProxy:i,target:e})),C.getOrElse(()=>je({target:e}))))._server.address().port;h('Intercepting request to "%s" via port: %d',t,a),Ge({socket:r,port:a})}function et(e,t=[]){let r=Ze.isEmpty(t)?!0:!(0,$e.isMatch)(e,t);return h('Should "%s" use upstream proxy with NO_PROXY %s: %s',e,t,r),r}function Ut(e){return e===ce("YXBpLmN5cHJlc3MuaW8=")}function Dt(e){return typeof e=="object"&&e!==null}var ee=require("fp-ts/function"),w=m(require("fp-ts/Option")),st=m(require("fs")),x=require("lodash"),it=m(require("tmp")),te=require("url");var tt=require("fp-ts/function"),P=m(require("fp-ts/Option")),rt=m(require("fs"));var ot=()=>(0,tt.pipe)(P.fromNullable(process.env.NODE_EXTRA_CA_CERTS),P.chain(e=>P.tryCatch(()=>rt.default.readFileSync(e))),P.map(e=>(l("Augmenting NODE_EXTRA_CA_CERTS: %s",process.env.NODE_EXTRA_CA_CERTS),`${z}
${e}`)),P.getOrElse(()=>z));B();var nt=e=>e==="false"||e==="0"||!e;function re(){let e=(0,x.pick)(process.env,["NO_PROXY","HTTP_PROXY","HTTPS_PROXY","no_proxy","http_proxy","https_proxy","npm_config_proxy","npm_config_https_proxy","npm_config_noproxy"]);l("Original environment variables %o",e),[["http_proxy","HTTP_PROXY"],["https_proxy","HTTPS_PROXY"],["no_proxy","NO_PROXY"]].forEach(([r,n])=>{nt(e[r])||(l("Copying lowercase %s to %s",r,n),e[n]=e[r])}),[["npm_config_proxy","HTTP_PROXY"],["npm_config_https_proxy","HTTPS_PROXY"]].forEach(([r,n])=>{!nt(e[r])&&(0,x.isUndefined)(e[n])&&(l("Using npm's %s as %s",r,n),e[n]=e[r])});let t={https_proxy:void 0,http_proxy:void 0,npm_config_proxy:void 0,npm_config_https_proxy:void 0,NO_PROXY:e.NO_PROXY,HTTP_PROXY:e.HTTP_PROXY,HTTPS_PROXY:e.HTTPS_PROXY};return l("Sanitized environment variables %o",t),t}function oe({port:e}){let t=ot(),r=it.default.fileSync();return st.default.writeFileSync(r.name,t),{caPath:r.name,proxyURL:`http://127.0.0.1:${e}`}}function ne(e){return(0,ee.pipe)(w.fromNullable(e.HTTPS_PROXY),w.map(t=>({source:"HTTPS_PROXY",value:t})),w.alt(()=>(0,ee.pipe)(w.fromNullable(e.HTTP_PROXY),w.map(t=>({source:"HTTP_PROXY",value:t})))),w.map(t=>(Lt(t.source,new te.URL(t.value)),new te.URL(t.value))),w.fold(()=>null,t=>(l("Using upstream proxy %o",t),t)))}function Lt(e,t){t.protocol==="http:"&&e==="HTTPS_PROXY"&&O("Mismatch between protocol 'http' and env variable HTTPS_PROXY: %s. Use HTTP_PROXY instead.",t),t.protocol==="https:"&&e==="HTTP_PROXY"&&O("Mismatch between protocol 'https' and env variable HTTP_PROXY: %s. USE HTTPS_PROXY instead.",t)}function se(e,t){return(0,x.chain)({...t,HTTP_PROXY:void 0,HTTPS_PROXY:e.proxyURL,NODE_EXTRA_CA_CERTS:e.caPath,CYPRESS_API_URL:void 0}).tap(r=>l("Resolved proxy environment variables %o",r)).value()}function at(e){Object.entries(e).forEach(([t,r])=>{if((0,x.isUndefined)(r)){l("Deleting env %s",t),process.env[t]=r,delete process.env[t];return}l("Setting env %s=%s",t,r),process.env[t]=r})}async function ut(e){l("Cypress API URL: %s",e),l("Package version: %s",K.version);let[,,...t]=process.argv,r=await U(),n=(0,ct.platform)()==="win32",o=n?"node":r,s=n?[r,...t]:t;l("Running cypress: %o",[o,...s]);let a=re(),i=ne(a),{port:p}=await $({target:e,upstreamProxy:i,envVariables:a});pt.default.spawn(o,s,{stdio:"inherit",env:{...process.env,...se(oe({port:p}),a)}}).on("exit",g=>{process.exit(g??1)})}async function dt(e,t){if(l("Cypress API URL: %s",e),l("Package version: %s",K.version),!e)throw new Error("Missing API URL");let r=require("cypress"),n={...process.env},o=re(),s=ne(o),{port:a,stop:i}=await $({target:e,upstreamProxy:s,envVariables:o});try{return at(se(oe({port:a}),o)),await r.run(t)}finally{process.env=n,await i()}}0&&(module.exports={getCypressCLIBinPath,run,spawn});
/*! For license information please see index.js.LEGAL.txt */
//# sourceMappingURL=index.js.map
