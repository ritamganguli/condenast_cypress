var ut=Object.create;var k=Object.defineProperty;var Rt=Object.getOwnPropertyDescriptor;var ht=Object.getOwnPropertyNames;var mt=Object.getPrototypeOf,Ut=Object.prototype.hasOwnProperty;var ae=(e,t)=>()=>(e&&(t=e(e=0)),t);var w=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),B=(e,t)=>{for(var r in t)k(e,r,{get:t[r],enumerable:!0})},pe=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of ht(t))!Ut.call(e,n)&&n!==r&&k(e,n,{get:()=>t[n],enumerable:!(o=Rt(t,n))||o.enumerable});return e};var m=(e,t,r)=>(r=e!=null?ut(mt(e)):{},pe(t||!e||!e.__esModule?k(r,"default",{value:e,enumerable:!0}):r,e)),X=e=>pe(k({},"__esModule",{value:!0}),e);var de={};B(de,{error:()=>j,warn:()=>W});var L,z,W,j,P=ae(()=>{L=m(require("chalk")),z=m(require("util")),W=(...e)=>console.warn(L.default.bgYellow.black(`
 WARNING `),z.default.format(...e),`
`),j=(...e)=>console.warn(L.default.bgRed.black(`
 ERROR `),z.default.format(...e),`
`)});var Re={};B(Re,{debugHttpProxy:()=>ft});var ue,ft,he=ae(()=>{ue=require("debug"),ft=(0,ue.debug)("cy2-http-proxy")});var H=w(Ue=>{var S=Ue,Tt=require("url"),me=require("util")._extend,Nt=require("requires-port"),St=/(^|,)\s*upgrade\s*($|,)/i,D=/^https|wss/;S.isSSL=D;S.setupOutgoing=function(e,t,r,o){let n={...t};r.url==="/preflight"&&(n.target=new URL("https://api.cypress.io")),e.port=n[o||"target"].port||(D.test(n[o||"target"].protocol)?443:80),["host","hostname","socketPath","pfx","key","passphrase","cert","ca","ciphers","secureProtocol"].forEach(function(p){e[p]=n[o||"target"][p]}),e.method=n.method||r.method,e.headers=me({},r.headers),n.headers&&me(e.headers,n.headers),n.auth&&(e.auth=n.auth),n.ca&&(e.ca=n.ca),D.test(n[o||"target"].protocol)&&(e.rejectUnauthorized=typeof n.secure>"u"?!0:n.secure),e.agent=n.agent||!1,e.localAddress=n.localAddress,e.agent||(e.headers=e.headers||{},(typeof e.headers.connection!="string"||!St.test(e.headers.connection))&&(e.headers.connection="close"));var s=n[o||"target"],a=s&&n.prependPath!==!1&&s.path||"",i=n.toProxy?r.url:Tt.parse(r.url).path||"";return i=n.ignorePath?"":i,e.path=S.urlJoin(a,i),n.changeOrigin&&(e.headers.host=Nt(e.port,n[o||"target"].protocol)&&!Et(e.host)?e.host+":"+e.port:e.host),e};S.setupSocket=function(e){return e.setTimeout(0),e.setNoDelay(!0),e.setKeepAlive(!0,0),e};S.getPort=function(e){var t=e.headers.host?e.headers.host.match(/:(\d+)/):"";return t?t[1]:S.hasEncryptedConnection(e)?"443":"80"};S.hasEncryptedConnection=function(e){return Boolean(e.connection.encrypted||e.connection.pair)};S.urlJoin=function(){var e=Array.prototype.slice.call(arguments),t=e.length-1,r=e[t],o=r.split("?"),n;return e[t]=o.shift(),n=[e.filter(Boolean).join("/").replace(/\/+/g,"/").replace("http:/","http://").replace("https:/","https://")],n.push.apply(n,o),n.join("?")};S.rewriteCookieProperty=function e(t,r,o){return Array.isArray(t)?t.map(function(n){return e(n,r,o)}):t.replace(new RegExp("(;\\s*"+o+"=)([^;]+)","i"),function(n,s,a){var i;if(a in r)i=r[a];else if("*"in r)i=r["*"];else return n;return i?s+i:""})};function Et(e){return!!~e.indexOf(":")}});var Ne=w((qt,Te)=>{var Ve=require("url"),fe=H(),yt=/^201|30(1|2|7|8)$/;Te.exports={removeChunked:function(t,r,o){t.httpVersion==="1.0"&&delete o.headers["transfer-encoding"]},setConnection:function(t,r,o){t.httpVersion==="1.0"?o.headers.connection=t.headers.connection||"close":t.httpVersion!=="2.0"&&!o.headers.connection&&(o.headers.connection=t.headers.connection||"keep-alive")},setRedirectHostRewrite:function(t,r,o,n){if((n.hostRewrite||n.autoRewrite||n.protocolRewrite)&&o.headers.location&&yt.test(o.statusCode)){var s=Ve.parse(n.target),a=Ve.parse(o.headers.location);if(s.host!=a.host)return;n.hostRewrite?a.host=n.hostRewrite:n.autoRewrite&&(a.host=t.headers.host),n.protocolRewrite&&(a.protocol=n.protocolRewrite),o.headers.location=a.format()}},writeHeaders:function(t,r,o,n){var s=n.cookieDomainRewrite,a=n.cookiePathRewrite,i=n.preserveHeaderKeyCase,p,U=function(l,u){u!=null&&(s&&l.toLowerCase()==="set-cookie"&&(u=fe.rewriteCookieProperty(u,s,"domain")),a&&l.toLowerCase()==="set-cookie"&&(u=fe.rewriteCookieProperty(u,a,"path")),r.setHeader(String(l).trim(),u))};if(typeof s=="string"&&(s={"*":s}),typeof a=="string"&&(a={"*":a}),i&&o.rawHeaders!=null){p={};for(var c=0;c<o.rawHeaders.length;c+=2){var d=o.rawHeaders[c];p[d.toLowerCase()]=d}}Object.keys(o.headers).forEach(function(l){var u=o.headers[l];i&&p&&(l=p[l]||l),U(l,u)})},writeStatusCode:function(t,r,o){o.statusMessage?(r.statusCode=o.statusCode,r.statusMessage=o.statusMessage):r.statusCode=o.statusCode}}});var Ee=w(($t,Se)=>{var Ft=require("http"),wt=require("https"),Y=Ne(),O=H(),gt=require("follow-redirects");Y=Object.keys(Y).map(function(e){return Y[e]});var bt={http:Ft,https:wt};Se.exports={deleteLength:function(t,r,o){(t.method==="DELETE"||t.method==="OPTIONS")&&!t.headers["content-length"]&&(t.headers["content-length"]="0",delete t.headers["transfer-encoding"])},timeout:function(t,r,o){o.timeout&&t.socket.setTimeout(o.timeout)},XHeaders:function(t,r,o){if(o.xfwd){var n=t.isSpdy||O.hasEncryptedConnection(t),s={for:t.connection.remoteAddress||t.socket.remoteAddress,port:O.getPort(t),proto:n?"https":"http"};["for","port","proto"].forEach(function(a){t.headers["x-forwarded-"+a]=(t.headers["x-forwarded-"+a]||"")+(t.headers["x-forwarded-"+a]?",":"")+s[a]}),t.headers["x-forwarded-host"]=t.headers["x-forwarded-host"]||t.headers.host||""}},stream:function(t,r,o,n,s,a){let i={...o};t.url==="/preflight"&&(i.target=new URL("https://api.cypress.io")),s.emit("start",t,r,i.target||i.forward);var p=i.followRedirects?gt:bt,U=p.http,c=p.https;if(i.forward){var d=(i.forward.protocol==="https:"?c:U).request(O.setupOutgoing(i.ssl||{},i,t,"forward")),l=Z(d,i.forward);if(t.on("error",l),d.on("error",l),(i.buffer||t).pipe(d),!i.target)return r.end()}var u=(i.target.protocol==="https:"?c:U).request(O.setupOutgoing(i.ssl||{},i,t));u.on("socket",function(N){s&&!u.getHeader("expect")&&s.emit("proxyReq",u,t,r,i)}),i.proxyTimeout&&u.setTimeout(i.proxyTimeout,function(){u.abort()}),t.on("aborted",function(){u.abort()});var y=Z(u,i.target);t.on("error",y),u.on("error",y);function Z(N,F){return function(C){if(t.socket.destroyed&&C.code==="ECONNRESET")return s.emit("econnreset",C,t,r,F),N.abort();a?a(C,t,r,F):s.emit("error",C,t,r,F)}}(i.buffer||t).pipe(u),u.on("response",function(N){if(s&&s.emit("proxyRes",N,t,r),!r.headersSent&&!i.selfHandleResponse)for(var F=0;F<Y.length&&!Y[F](t,r,N,i);F++);r.finished?s&&s.emit("end",t,r,N):(N.on("end",function(){s&&s.emit("end",t,r,N)}),i.selfHandleResponse||N.pipe(r))})}}});var Fe=w((er,ye)=>{var Zt=require("http"),Wt=require("https"),v=H();ye.exports={checkMethodAndHeader:function(t,r){if(t.method!=="GET"||!t.headers.upgrade||t.headers.upgrade.toLowerCase()!=="websocket")return r.destroy(),!0},XHeaders:function(t,r,o){if(o.xfwd){var n={for:t.connection.remoteAddress||t.socket.remoteAddress,port:v.getPort(t),proto:v.hasEncryptedConnection(t)?"wss":"ws"};["for","port","proto"].forEach(function(s){t.headers["x-forwarded-"+s]=(t.headers["x-forwarded-"+s]||"")+(t.headers["x-forwarded-"+s]?",":"")+n[s]})}},stream:function(t,r,o,n,s,a){var i=function(c,d){return Object.keys(d).reduce(function(l,u){var y=d[u];if(!Array.isArray(y))return l.push(u+": "+y),l;for(var Z=0;Z<y.length;Z++)l.push(u+": "+y[Z]);return l},[c]).join(`\r
`)+`\r
\r
`};v.setupSocket(r),n&&n.length&&r.unshift(n);var p=(v.isSSL.test(o.target.protocol)?Wt:Zt).request(v.setupOutgoing(o.ssl||{},o,t));return s&&s.emit("proxyReqWs",p,t,r,o,n),p.on("error",U),p.on("response",function(c){c.upgrade||(r.write(i("HTTP/"+c.httpVersion+" "+c.statusCode+" "+c.statusMessage,c.headers)),c.pipe(r))}),p.on("upgrade",function(c,d,l){d.on("error",U),d.on("end",function(){s.emit("close",c,d,l)}),r.on("error",function(){d.end()}),v.setupSocket(d),l&&l.length&&d.unshift(l),r.write(i("HTTP/1.1 101 Switching Protocols",c.headers)),d.pipe(r).pipe(d),s.emit("open",d),s.emit("proxySocket",d)}),p.end();function U(c){a?a(c,t,r):s.emit("error",c,t,r),r.end()}}}});var Ye=w((tr,Pe)=>{var{debugHttpProxy:A}=(he(),X(Re)),{error:Qt}=(P(),X(de)),{omit:we,pick:ge,isUndefined:vt}=require("lodash"),Qe=Pe.exports,be=require("util")._extend,Pt=require("url").parse,ve=require("eventemitter3"),Yt=require("http"),xt=require("https"),Ze=Ee(),We=Fe();Qe.Server=g;function I(e){return function(r){return function(n,s){var a=e==="ws"?this.wsPasses:this.webPasses,i=[].slice.call(arguments),p=i.length-1,U,c;typeof i[p]=="function"&&(c=i[p],p--);var d=r;if(!(i[p]instanceof Buffer)&&i[p]!==s&&(d=be({},r),be(d,i[p]),p--),i[p]instanceof Buffer&&(U=i[p]),["target","forward"].forEach(function(u){typeof d[u]=="string"&&(d[u]=Pt(d[u]))}),!d.target&&!d.forward)return this.emit("error",new Error("Must provide a proper URL as target"));vt(a==null?void 0:a.length)&&(Qt("Unexpected error processing the request. Please report the issue and the details below. Set environment variable DEBUG=cy2* and rerun to get more information"),console.error("Request: %o",ge(n,"httpVersion","method","url","headers","upgrade","aborted","complete")),console.error("Proxy: type %s, request options: %O",e,we(d,"ssl"))),A("applying passes, proxy type: %s, request options: %o",e,we(d,"ssl")),A("Request: %o",ge(n,"httpVersion","method","url","headers","upgrade","aborted","complete"));for(var l=0;l<a.length;l++)if(a[l](n,s,d,U,this,c)){A('pass halted the loop type "%s", #%d: %s %s',e,l,a[l].name,n.method,n.url);break}}}}Qe.createRightProxy=I;function g(e){ve.call(this),e=e||{},e.prependPath=e.prependPath!==!1,this.web=this.proxyRequest=I("web")(e),this.ws=this.proxyWebsocketRequest=I("ws")(e),this.options=e,this.webPasses=Object.keys(Ze).map(function(t){return Ze[t]}),this.wsPasses=Object.keys(We).map(function(t){return We[t]}),this.on("error",this.onError,this)}require("util").inherits(g,ve);g.prototype.onError=function(e){if(this.listeners("error").length===1)throw e};g.prototype.listen=function(e,t,r){var o=this,n=function(s,a){o.web(s,a)};return this._server=this.options.ssl?xt.createServer(this.options.ssl,n):Yt.createServer(n),this.options.ws&&this._server.on("upgrade",function(s,a,i){o.ws(s,a,i)}),this._server.listen(e,t,r),this};g.prototype.close=function(e){var t=this;this._server&&this._server.close(r);function r(){t._server=null,e&&e.apply(null,arguments)}};g.prototype.before=function(e,t,r){if(e!=="ws"&&e!=="web")throw new Error("type must be `web` or `ws`");var o=e==="ws"?this.wsPasses:this.webPasses,n=!1;if(o.forEach(function(s,a){s.name===t&&(n=a)}),n===!1)throw new Error("No such pass");o.splice(n,0,r)};g.prototype.after=function(e,t,r){if(e!=="ws"&&e!=="web")throw new Error("type must be `web` or `ws`");var o=e==="ws"?this.wsPasses:this.webPasses,n=!1;if(o.forEach(function(s,a){s.name===t&&(n=a)}),n===!1)throw new Error("No such pass");o.splice(n++,0,r)}});var Ce=w((rr,xe)=>{var x=Ye().Server;function q(e){return new x(e)}x.createProxyServer=q;x.createServer=q;x.createProxy=q;xe.exports=x});var Je=w((nr,ke)=>{ke.exports=Ce()});var Ot={};B(Ot,{getCypressCLIBinPath:()=>M,run:()=>lt,spawn:()=>ct});module.exports=X(Ot);var Qr=require("source-map-support/register");var J=require("path");var G=require("debug"),R=(0,G.debug)("cy2"),h=(0,G.debug)("cy2-net");P();async function M(){var e;if(process.env.CYPRESS_PACKAGE_SHELL_SCRIPT)return R("Cypress binary path from CYPRESS_PACKAGE_SHELL_SCRIPT: %s",process.env.CYPRESS_PACKAGE_SHELL_SCRIPT),process.env.CYPRESS_PACKAGE_SHELL_SCRIPT;try{let t=require.resolve("cypress"),r=require("cypress/package.json");if(!r.bin||!((e=r.bin)!=null&&e.cypress))throw new Error("Cannot detect cypress package executable");let o=(0,J.resolve)((0,J.dirname)(t),r.bin.cypress);if(R("Cypress binary path: %s",o),!o)throw new Error("Cannot detect cypress package executable");return o}catch(t){throw j("Cannot detect cypress package executable. Consider using CYPRESS_PACKAGE_SHELL_SCRIPT environment variable. Tried locations: %O",require.resolve.paths("cypress")),t}}var pt=m(require("child_process")),dt=require("os");var K={name:"cy2",version:"4.0.7-beta.1",author:"Andrew Goldis",main:"./dist",typings:"./dist",license:"GPL-3.0-or-later",repository:{type:"git",url:"https://github.com/sorry-cypress/cy2.git"},scripts:{postinstall:"patch-package",build:"run-p tsc esbuild",dev:"run-p watch:*",test:"jest",tsc:"tsc",esbuild:"node ./build.js","watch:tsc":'run-s "tsc --watch --preserveWatchOutput"',"watch:esbuild":"esbuild ./src/*.ts --bundle --platform=node --target=node14 --packages=external --sourcemap=inline --outdir=dist --watch","build-tunnel":"esbuild ./src/tunnel-proxy.ts --bundle --platform=node --target=node14 --packages=external --sourcemap=inline --outdir=dist",release:"release-it","release-ci":"release-it --ci --npm.skipChecks --no-git --no-github --no-increment --npm.publish",clean:"rimraf dist"},files:["bin/*","dist/index.js*","!dist/__tests__","!dist/*.d.ts","!dist/**/*.d.ts","dist/index.d.ts","dist/cypress-wrapper.d.ts","dist/bin-path.d.ts"],bin:{cy2:"bin/cy2"},engines:{node:">=14.17.0"},keywords:["cypress","sorry-cypress","cypress dashboard","cypress ci","cypress parallel","currents"],dependencies:{chalk:"^4.1.2",eventemitter3:"^4.0.0","follow-redirects":"^1.0.0","fp-ts":"^2.13.1","http-terminator":"^3.2.0","https-proxy-agent":"^5.0.1",lodash:"^4.17.21",micromatch:"^4.0.5","patch-package":"^6.5.1","requires-port":"^1.0.0","source-map-support":"^0.5.21",tmp:"^0.2.1"},devDependencies:{"@release-it/conventional-changelog":"^5.1.1","@types/http-proxy":"^1.17.9","@types/jest":"^27.0.1","@types/lodash":"^4.14.191","@types/micromatch":"^4.0.2","@types/node":"^18.11.17",cypress:">=6.7.0",devcert:"^1.2.2",esbuild:"^0.16.13",jest:"^29.3.1","npm-run-all":"^4.1.5","release-it":"^15.6.0",rimraf:"^3.0.2","ts-jest":"^29.0.3",typescript:"^4.9.4"},"release-it":{npm:{publish:!1},github:{release:!0},plugins:{"@release-it/conventional-changelog":{preset:"angular",header:"# Changelog",ignoreVersion:!0,infile:"CHANGELOG.md"}},git:{requireBranch:"main",commitMessage:"chore: release v${version}"},hooks:{"before:init":"run-s clean build"}},prettier:{singleQuote:!0}};var De=m(require("fp-ts/Array")),Ae=require("fp-ts/function"),E=m(require("fp-ts/Option")),Ie=m(require("http")),qe=require("http-terminator"),$e=require("micromatch");var Q=(e,t="base64")=>Buffer.from(e,t).toString();var Me=require("https-proxy-agent");var ce=Q("LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUR6ekNDQXJlZ0F3SUJBZ0lKQUxKbGJVZmRBK2s1TUEwR0NTcUdTSWIzRFFFQkN3VUFNRDR4RnpBVkJnTlYKQkFNTURtRndhUzVqZVhCeVpYTnpMbWx2TVFzd0NRWURWUVFHRXdKVlV6RVdNQlFHQTFVRUJ3d05VMkZ1SUVaeQpZVzV6YVhOamJ6QWVGdzB5TWpFeU1UY3dPREUxTkRGYUZ3MHlNekV5TVRjd09ERTFOREZhTUgweEN6QUpCZ05WCkJBWVRBbFZUTVJNd0VRWURWUVFJREFwRFlXeHBabTl5Ym1saE1SWXdGQVlEVlFRSERBMVRZVzRnUm5KaGJuTnAKYzJOdk1SRXdEd1lEVlFRS0RBaElaV3hzYjBoMVlqRVZNQk1HQTFVRUN3d01TR1ZzYkc5SWRXSWdSR1YyTVJjdwpGUVlEVlFRRERBNWhjR2t1WTNsd2NtVnpjeTVwYnpDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDCkFRb0NnZ0VCQU13eVZIellGZmUwUllLVVRzRXpsNjJVYjdXQXFZVUxsZjRrNWFsR21LMjhPYWpHWHFlTGFWd2oKVjc3NXBKVS9ENTg1dzlqbnBwMDRoOTZTVTRtWDNPUVFUN3hKcTRXMlFTSzNHeHRkTkhINHNLWlgrU0FUR2l2MQpYUFZhZlBmbVZsMjcwOVRXNFNBYzZyV2hhclNpdVdVTTU1THhpek9xQ3pYS1RqQWJOam40YStMcDlQaDRST2JTCnYzMjdRQU56U2txcVVocjFlYjhFZ1BkUmNuYXFtYmVES2hZNmlYcmdzTXYzaXB6OUs5QlFKL2wyMVUxNXR5NnYKV2dNSWlrT2hHOEdaOUdhb1RDYUg3Z2xPY1k0djNRVnZldUE4d2YrNXJhQzR1UVV3bDhjeVFBNERGK3VLZWQ2bAp2dkN4aStJNjFnT21ORVcvQ1ZEb2lGZkFBcWVHZnhFQ0F3RUFBYU9Ca0RDQmpUQllCZ05WSFNNRVVUQlBvVUtrClFEQStNUmN3RlFZRFZRUUREQTVoY0drdVkzbHdjbVZ6Y3k1cGJ6RUxNQWtHQTFVRUJoTUNWVk14RmpBVUJnTlYKQkFjTURWTmhiaUJHY21GdWMybHpZMitDQ1FEdWRQbUc0OGUrQ3pBSkJnTlZIUk1FQWpBQU1Bc0dBMVVkRHdRRQpBd0lFOERBWkJnTlZIUkVFRWpBUWdnNWhjR2t1WTNsd2NtVnpjeTVwYnpBTkJna3Foa2lHOXcwQkFRc0ZBQU9DCkFRRUFyS3JDYVpxZ2FWb2hPNUdIN1N2NXlzSm4xYk51VzJlV2pOYUlESW9POWtGTVVXTzk4bFlocmEwQzdtdzcKdm4yalB4QWVQSVpnNDRhV1ZQdXNuSGpqQytJS0FTTndYc05GdWdDSStydnVrakh0Ri9qQ2dNUFhOYXJWVnByYgowK1RyKzNiNys2TU1zT0ZMOUd2Z1JLT2ZGdXJKNTR2Smpkb1Bqem9WWG4vL3M4NVVHbmFlR2VZZGhXMEJncmlNCkFNVkhlMDJzSlJuY3dnWUo4REVab2gzbWo4WGhRQWNpOW92aWYwei94U3luYllGUWVTSUtReFNWcFBQM0N5bUEKVHZxSzdGbENlVytDRWM1TUhOc1BIOTZLelZtUy9XYzBuRFFHNld1ZzRsUU9hdG0zVnIyWFVYZ05ESnVidjJsRgpZVXhmSFl4RStrNExYUVI3czk3R0l2RjUwUT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0KLS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBekRKVWZOZ1Y5N1JGZ3BST3dUT1hyWlJ2dFlDcGhRdVYvaVRscVVhWXJidzVxTVplCnA0dHBYQ05YdnZta2xUOFBuem5EMk9lbW5UaUgzcEpUaVpmYzVCQlB2RW1yaGJaQklyY2JHMTAwY2Zpd3BsZjUKSUJNYUsvVmM5VnA4OStaV1hidlQxTmJoSUJ6cXRhRnF0S0s1WlF6bmt2R0xNNm9MTmNwT01CczJPZmhyNHVuMAorSGhFNXRLL2ZidEFBM05LU3FwU0d2VjV2d1NBOTFGeWRxcVp0NE1xRmpxSmV1Q3d5L2VLblAwcjBGQW4rWGJWClRYbTNMcTlhQXdpS1E2RWJ3Wm4wWnFoTUpvZnVDVTV4amkvZEJXOTY0RHpCLzdtdG9MaTVCVENYeHpKQURnTVgKNjRwNTNxVys4TEdMNGpyV0E2WTBSYjhKVU9pSVY4QUNwNFovRVFJREFRQUJBb0lCQUNONTB3ZmxtdHR3TEd0bApUTkZ3SHpmL0EvRnFxd2o4WEZETkpFRm1qSHdTcVluUy9QcnEwNkU0V3JSSk52amUvZDNSOFY2cjBGeWNSNjY1CmlWM3NUbW9wRTFGSkUwMmx2bWREbktnQ1oyd3Rvck1qc1pxSzl3OFFEOWhvb2pHSGlSVzczaStxTFc2ZzEzNDYKendrWEJGSzBEVCtRUzNqc1lBbzJYYU1wOXgvVzR6bzJYQjdsV0piZ3ZtN1JmYWNwTXlpbERaU1VBMU9MQnJhYwpjdW4rbHduK0V4Z1pXWjR2RVR6Si9vY3dNMEFXT2FRTkdkc3cvL1lSQ29SVEZsVy9VZDBQTk1kU2JpQXhmMEkvClVtM0diNHp6Uk1ibzV1T0syd3BHSkNLNUtQRmM3Nm0vaGRRVVFHUGRjVWlkV3pMR3EyRHdaOUJGNTRqclpROGwKRE84THY4a0NnWUVBL1dCb1Rsa2Y5K3BVb0ROL1p1c0I3M2JqSU5hNTd4TUdsUDdjMUwwZWttR0VKdHNDNlFKVApjRXUzY3BqTTNoU0RjZVNYSFN5aUNKdFB0N3FYOTZVendlOWFkZnpFMldqQ0hYRDdMeXNpdkVRNjFOTHBJQ1d4Cnk4UWxTRG1sVDA3d1ZEN3cyUXY0ZUxITnJoL3BTNEtlMklwb1phaEdCNndFSEcyUXJOS2lkQ01DZ1lFQXprK1IKU3NWRHQ1bG1Od3JyMXhvdFp0WktvSjFIQXJNNVJlbm5wMVorcG1yNGpzNTUwMHR2RjM1c2lYemRkckZKL3pGRwoxUElsb1RKRUpVbWVKNnJZaitpZUoyOUI1SE01bmxPOG1sMFluQjFIMnh3VlQ5SXF6eFd6L09UM2Ivd0QxOGh2Ck0vU0YvTnNOU0FqTUgzUk1IOVpyUUpldG4ycWpjYWlUS1UvRmlUc0NnWUVBejJodW1jdnRGbFMwcDFyZ2JFL3QKaXFkSUwyWjJWNVM4YTVUaEVpZ3BjV3Z2OEpxUkhFbnlJVmRwdUo0Si9iVFBFSmt0ZGcxR0trTndreFprTmF6KwozRDdoVHZuMTdYNEtnRzB1d0tMUDBVc00yWkE0a3o4bjlvUCtmTXZyWFN0aUlhUlFKV3ZlSG5aMXhwYUtzMndlCk9XVzdKWlFFbDEwaEZHQS84S2lQb1A4Q2dZQi82MC9mOTMzc1NkM1p4UmpENzRRMUhpdDVlT3M5bmxpbG84a3gKdFd5anpQRyt3Z0ZCWktWR0FPcFZPU21yM1hOUEdvT2JwMlJ6bFZJeGVIcnFoNER0Z2NNR0duTFZyaWdNcGtqcgp3VXR3Q0t1MERLNmVKbWJLcmQ5Q3I4bElFdzlpN1BFZVdyLzFMdkVHT0FZd2ZwQndzU2NoRHFybGpGNDVLOWZMCkpwNEpYd0tCZ0VLQjQxazhQSUNmQnZ1QjdobUdmNFpKay8yc3hubGFtQkV4a0lKTWhrbmVpWi94YkNXVVJ1RHMKaW1tTXYxaytzK2trLzZTc2VRb1dNTTZvVCtwUVJzN2NiUHNkbmNPNFJKY2dTaXBZQlNoRWtjYUZSdVp2NkdqVwpqN0RnQ0VRZSs2SkdrMVdKakxTbGRobUxwdEg2K2tuSXcxcUdzUEVwMEk4VDVhbDZleE44Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0t"),le=Q("LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBekRKVWZOZ1Y5N1JGZ3BST3dUT1hyWlJ2dFlDcGhRdVYvaVRscVVhWXJidzVxTVplCnA0dHBYQ05YdnZta2xUOFBuem5EMk9lbW5UaUgzcEpUaVpmYzVCQlB2RW1yaGJaQklyY2JHMTAwY2Zpd3BsZjUKSUJNYUsvVmM5VnA4OStaV1hidlQxTmJoSUJ6cXRhRnF0S0s1WlF6bmt2R0xNNm9MTmNwT01CczJPZmhyNHVuMAorSGhFNXRLL2ZidEFBM05LU3FwU0d2VjV2d1NBOTFGeWRxcVp0NE1xRmpxSmV1Q3d5L2VLblAwcjBGQW4rWGJWClRYbTNMcTlhQXdpS1E2RWJ3Wm4wWnFoTUpvZnVDVTV4amkvZEJXOTY0RHpCLzdtdG9MaTVCVENYeHpKQURnTVgKNjRwNTNxVys4TEdMNGpyV0E2WTBSYjhKVU9pSVY4QUNwNFovRVFJREFRQUJBb0lCQUNONTB3ZmxtdHR3TEd0bApUTkZ3SHpmL0EvRnFxd2o4WEZETkpFRm1qSHdTcVluUy9QcnEwNkU0V3JSSk52amUvZDNSOFY2cjBGeWNSNjY1CmlWM3NUbW9wRTFGSkUwMmx2bWREbktnQ1oyd3Rvck1qc1pxSzl3OFFEOWhvb2pHSGlSVzczaStxTFc2ZzEzNDYKendrWEJGSzBEVCtRUzNqc1lBbzJYYU1wOXgvVzR6bzJYQjdsV0piZ3ZtN1JmYWNwTXlpbERaU1VBMU9MQnJhYwpjdW4rbHduK0V4Z1pXWjR2RVR6Si9vY3dNMEFXT2FRTkdkc3cvL1lSQ29SVEZsVy9VZDBQTk1kU2JpQXhmMEkvClVtM0diNHp6Uk1ibzV1T0syd3BHSkNLNUtQRmM3Nm0vaGRRVVFHUGRjVWlkV3pMR3EyRHdaOUJGNTRqclpROGwKRE84THY4a0NnWUVBL1dCb1Rsa2Y5K3BVb0ROL1p1c0I3M2JqSU5hNTd4TUdsUDdjMUwwZWttR0VKdHNDNlFKVApjRXUzY3BqTTNoU0RjZVNYSFN5aUNKdFB0N3FYOTZVendlOWFkZnpFMldqQ0hYRDdMeXNpdkVRNjFOTHBJQ1d4Cnk4UWxTRG1sVDA3d1ZEN3cyUXY0ZUxITnJoL3BTNEtlMklwb1phaEdCNndFSEcyUXJOS2lkQ01DZ1lFQXprK1IKU3NWRHQ1bG1Od3JyMXhvdFp0WktvSjFIQXJNNVJlbm5wMVorcG1yNGpzNTUwMHR2RjM1c2lYemRkckZKL3pGRwoxUElsb1RKRUpVbWVKNnJZaitpZUoyOUI1SE01bmxPOG1sMFluQjFIMnh3VlQ5SXF6eFd6L09UM2Ivd0QxOGh2Ck0vU0YvTnNOU0FqTUgzUk1IOVpyUUpldG4ycWpjYWlUS1UvRmlUc0NnWUVBejJodW1jdnRGbFMwcDFyZ2JFL3QKaXFkSUwyWjJWNVM4YTVUaEVpZ3BjV3Z2OEpxUkhFbnlJVmRwdUo0Si9iVFBFSmt0ZGcxR0trTndreFprTmF6KwozRDdoVHZuMTdYNEtnRzB1d0tMUDBVc00yWkE0a3o4bjlvUCtmTXZyWFN0aUlhUlFKV3ZlSG5aMXhwYUtzMndlCk9XVzdKWlFFbDEwaEZHQS84S2lQb1A4Q2dZQi82MC9mOTMzc1NkM1p4UmpENzRRMUhpdDVlT3M5bmxpbG84a3gKdFd5anpQRyt3Z0ZCWktWR0FPcFZPU21yM1hOUEdvT2JwMlJ6bFZJeGVIcnFoNER0Z2NNR0duTFZyaWdNcGtqcgp3VXR3Q0t1MERLNmVKbWJLcmQ5Q3I4bElFdzlpN1BFZVdyLzFMdkVHT0FZd2ZwQndzU2NoRHFybGpGNDVLOWZMCkpwNEpYd0tCZ0VLQjQxazhQSUNmQnZ1QjdobUdmNFpKay8yc3hubGFtQkV4a0lKTWhrbmVpWi94YkNXVVJ1RHMKaW1tTXYxaytzK2trLzZTc2VRb1dNTTZvVCtwUVJzN2NiUHNkbmNPNFJKY2dTaXBZQlNoRWtjYUZSdVp2NkdqVwpqN0RnQ0VRZSs2SkdrMVdKakxTbGRobUxwdEg2K2tuSXcxcUdzUEVwMEk4VDVhbDZleE44Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg=="),_=process.env.CY2_EMPTY_CA?"":Q("LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMrRENDQWVBQ0NRRHVkUG1HNDhlK0N6QU5CZ2txaGtpRzl3MEJBUXNGQURBK01SY3dGUVlEVlFRRERBNWgKY0drdVkzbHdjbVZ6Y3k1cGJ6RUxNQWtHQTFVRUJoTUNWVk14RmpBVUJnTlZCQWNNRFZOaGJpQkdjbUZ1YzJsegpZMjh3SGhjTk1qSXhNakUzTURneE5EQTFXaGNOTWpNeE1qQTRNRGd4TkRBMVdqQStNUmN3RlFZRFZRUUREQTVoCmNHa3VZM2x3Y21WemN5NXBiekVMTUFrR0ExVUVCaE1DVlZNeEZqQVVCZ05WQkFjTURWTmhiaUJHY21GdWMybHoKWTI4d2dnRWlNQTBHQ1NxR1NJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUUMyY1ZFWlRSb0E1czMrY2dRSAo1SDRkdysyYnR0S0xidEVneC90bzdwVzAwNlMvL3NpQTBtRWlMUHpvcXJjTXZsamgyVHJ2YmhDT1gzc05xWWlSCjZQL3VMNUxXUkVRKzgyTGxDNHg3WTNvYlFqZGVZd3RCbHNlUXRvNmQ2b3I1eCtFNm1BRURvbU5sclZkT2U5U3AKNU9iRmx4Qk9ZOGlzYXJhN1l1MnM0Q0RmcHlwa0NMRmxEWkJtZHBjY1hEMDNUNGtXVE43TnRyTFE5UmxsN1J0Qgp3UHhTeWdROTBvYUZ5TUF1RkxRSGZ1K095NHdqZmhpVWt1ZkV5WHk4T25NZGNNdjVmdXJrYlJQM0Joa0tWOVk3ClllUi80OFNwcDlUUjJNZEtNNkVtU2FnSkNiWC9TdEtmZmVEUi9UQnNEOXJuTDBVa1ZOaWJzTlhqcVF0cSs3UXAKdU8zdEFnTUJBQUV3RFFZSktvWklodmNOQVFFTEJRQURnZ0VCQUd5bndldGk5T2VFd0dkMGN4SVhFQUFyRHZpZgp2ekVSamh3dzVKOWFqZFU4Wk5heHlBVG1LN1lMa2U2b2NDZE1zU2hHU1lIWFp6UFZZRjk3cFFwTVM1WTdrbVBHCk9pU29Ec0duVUdWTEdLTE05TTJNcmxMN3NYeTl4UUZFSUNEbk9TMzZFWHhvOHpHK0RsUzZuMVFmeU9saThtaHIKUjhvRyttS0I1MDh0ejVPS1VYUXNXNG4rRE1XeE9RaXBGVXEvVGhYSkROb05iWlEwL2tKVUh1bTFSS3J6MHhpZgphWXJ6bGJDU1RkQ1VxWXQ1YVhDYml6aGtSQ2dhT2M4NWxqcXBZT3F5THhUSEVySWZySWE1U1NJRVZWanlTVnNGCnFXNTRoV0EwWmY4ZHVicEFRV2tLVEY5T1NvdEtnVENyVmU0RGdub2lwTlYyenViVm0raUIybFBEQmZRPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==");var He=m(Je());P();var f=new Map;async function Oe(){h("Stopping interceptors"),await Promise.all(Array.from(f.values()).map((e,t,r)=>new Promise(o=>e.close(()=>{h("Stopped interceptor %d/%d",t+1,r.length),o()})))),f.clear()}async function Be({target:e,upstreamProxy:t}){if(f.has("upstream"))return h("Using interceptor with upstream routing",t.toString(),e),f.get("upstream");h("Creating interceptor with upstream routing path: %s -> %s",t.toString(),e);let r=new Me.HttpsProxyAgent({protocol:t.protocol,host:t.hostname,port:t.port,path:t.pathname});return f.set("upstream",await Ge({target:e,agent:r})),f.get("upstream")}async function Xe({target:e}){return f.has("direct")?(h("Using interceptor with direct routing"),f.get("direct")):(h("Creating interceptor with direct routing path: %s",e),f.set("direct",await Ge({target:e})),f.get("direct"))}function Ge({target:e,agent:t}){return new Promise(r=>{h("Creating interceptor for %s",e);let o=He.createProxyServer({target:e,changeOrigin:!0,followRedirects:!0,agent:t,ssl:{key:le,cert:ce}}).on("error",n=>{let s=Boolean(t)?"upstream proxy":"direct";h("Interceptor of type %s error: %s",s,n),W("Error connecting to %s: %s",e,n.message)});o.listen(0,void 0,()=>r(o))})}var $=m(require("net"));function Le({socket:e,port:t,hostname:r}){let o=$.default.connect(t,r);o.on("ready",function(){e.pipe(o),o.pipe(e),e.write(`HTTP/1.1 200 OK\r
\r
`)}),o.on("error",function(){o.end(),o.destroy(),e.end(),e.destroy()}),e.on("error",function(){e.end(),e.destroy(),o.end(),o.destroy()})}function ze({socket:e,port:t}){let r=$.default.connect(t);r.on("ready",()=>{r.pipe(e),e.pipe(r),e.write(`HTTP/1.1 200 OK\r
\r
`)}),r.on("error",()=>{e.end(),e.destroy()}),r.on("end",()=>{e.end(),e.destroy()}),e.on("error",()=>{r.end(),r.destroy()}),e.on("end",()=>{r.end(),r.destroy()})}var je=m(require("http")),Ke=m(require("https"));function _e(e,t,r){h("Proxy chain to upstream for",e.url),r.protocol==="https:"?Ke.default:je.default.request({method:"CONNECT",path:e.url,headers:e.headers,agent:!1,hostname:r.hostname,port:r.port,protocol:r.protocol}).once("upgrade",n).once("connect",s).once("error",a).once("response",o).end();function o(i){i.upgrade=!0}function n(i,p){process.nextTick(function(){s(i,p)})}function s(i,p){p.setNoDelay(!0),p.removeAllListeners(),i.statusCode===200?(t.pipe(p),p.pipe(t),t.write(`HTTP/1.1 200 OK\r
\r
`)):(t.write(`HTTP/1.1 500 SERVER ERROR\r
\r
`),t.end(),t.destroy()),p.on("error",()=>{p.end(),p.destroy(),t.end(),t.destroy()}),t.on("error",()=>{p.end(),p.destroy(),t.end(),t.destroy()})}function a(i){console.error("Upstream proxy connection error",i),t.end(),t.destroy()}}async function ee({target:e="https://cy.currents.dev",upstreamProxy:t=null,envVariables:r={}}){return new Promise((o,n)=>{var U;let s=Ct(t,e,(U=r.NO_PROXY)==null?void 0:U.split(",")),a=Ie.default.createServer(),i=(0,qe.createHttpTerminator)({server:a});async function p(){h("Stopping proxy"),await i.terminate()}a.on("connect",s).listen(0,()=>{let c=a.address();if(!Mt(c)){n(new Error("Unable to detect proxy address"));return}h("Proxy is listening on port %d",c.port),o({stop:async()=>{await Oe(),await p(),h("Stopped proxy + interceptors")},port:c.port})})})}var Ct=(e,t,r=[])=>function(n,s){if(h("Connection request: %s",n.url),!n.url)throw new Error("Missing req.url in connect handler");let[a,i]=n.url.split(":",2);if(Jt(a)){kt({target:t,hostname:a,socket:s,upstreamProxy:e,noProxy:r});return}if(e&&et(a,r)){_e(n,s,e);return}Le({socket:s,port:parseInt(i,10),hostname:a})};async function kt({target:e,hostname:t,socket:r,upstreamProxy:o=null,noProxy:n=[]}){let a=(await(0,Ae.pipe)(o,E.fromNullable,E.filter(()=>et(new URL(e).hostname,n)),E.map(i=>Be({upstreamProxy:i,target:e})),E.getOrElse(()=>Xe({target:e}))))._server.address().port;h('Intercepting request to "%s" via port: %d',t,a),ze({socket:r,port:a})}function et(e,t=[]){let r=De.isEmpty(t)?!0:!(0,$e.isMatch)(e,t);return h('Should "%s" use upstream proxy with NO_PROXY %s: %s',e,t,r),r}function Jt(e){return e===Q("YXBpLmN5cHJlc3MuaW8=")}function Mt(e){return typeof e=="object"&&e!==null}var te=require("fp-ts/function"),V=m(require("fp-ts/Option")),st=m(require("fs")),b=require("lodash"),it=m(require("tmp")),re=require("url");var tt=require("fp-ts/function"),T=m(require("fp-ts/Option")),rt=m(require("fs"));var nt=()=>(0,tt.pipe)(T.fromNullable(process.env.NODE_EXTRA_CA_CERTS),T.chain(e=>T.tryCatch(()=>rt.default.readFileSync(e))),T.map(e=>(R("Augmenting NODE_EXTRA_CA_CERTS: %s",process.env.NODE_EXTRA_CA_CERTS),`${_}
${e}`)),T.getOrElse(()=>_));P();var ot=e=>e==="false"||e==="0"||!e;function ne(){let e=(0,b.pick)(process.env,["NO_PROXY","HTTP_PROXY","HTTPS_PROXY","no_proxy","http_proxy","https_proxy","npm_config_proxy","npm_config_https_proxy","npm_config_noproxy"]);R("Original environment variables %o",e),[["http_proxy","HTTP_PROXY"],["https_proxy","HTTPS_PROXY"],["no_proxy","NO_PROXY"]].forEach(([r,o])=>{ot(e[r])||(R("Copying lowercase %s to %s",r,o),e[o]=e[r])}),[["npm_config_proxy","HTTP_PROXY"],["npm_config_https_proxy","HTTPS_PROXY"]].forEach(([r,o])=>{!ot(e[r])&&(0,b.isUndefined)(e[o])&&(R("Using npm's %s as %s",r,o),e[o]=e[r])});let t={https_proxy:void 0,http_proxy:void 0,npm_config_proxy:void 0,npm_config_https_proxy:void 0,NO_PROXY:e.NO_PROXY,HTTP_PROXY:e.HTTP_PROXY,HTTPS_PROXY:e.HTTPS_PROXY};return R("Sanitized environment variables %o",t),t}function oe({port:e}){let t=nt(),r=it.default.fileSync();return st.default.writeFileSync(r.name,t),{caPath:r.name,proxyURL:`http://127.0.0.1:${e}`}}function se(e){return(0,te.pipe)(V.fromNullable(e.HTTPS_PROXY),V.map(t=>({source:"HTTPS_PROXY",value:t})),V.alt(()=>(0,te.pipe)(V.fromNullable(e.HTTP_PROXY),V.map(t=>({source:"HTTP_PROXY",value:t})))),V.map(t=>(Ht(t.source,new re.URL(t.value)),new re.URL(t.value))),V.fold(()=>null,t=>(R("Using upstream proxy %o",t),t)))}function Ht(e,t){t.protocol==="http:"&&e==="HTTPS_PROXY"&&W("Mismatch between protocol 'http' and env variable HTTPS_PROXY: %s. Use HTTP_PROXY instead.",t),t.protocol==="https:"&&e==="HTTP_PROXY"&&W("Mismatch between protocol 'https' and env variable HTTP_PROXY: %s. USE HTTPS_PROXY instead.",t)}function ie(e,t){return(0,b.chain)({...t,HTTP_PROXY:void 0,HTTPS_PROXY:e.proxyURL,NODE_EXTRA_CA_CERTS:e.caPath,CYPRESS_API_URL:void 0}).tap(r=>R("Resolved proxy environment variables %o",r)).value()}function at(e){Object.entries(e).forEach(([t,r])=>{if((0,b.isUndefined)(r)){R("Deleting env %s",t),process.env[t]=r,delete process.env[t];return}R("Setting env %s=%s",t,r),process.env[t]=r})}async function ct(e){R("Cypress API URL: %s",e),R("Package version: %s",K.version);let[,,...t]=process.argv,r=await M(),o=(0,dt.platform)()==="win32",n=o?"node":r,s=o?[r,...t]:t;R("Running cypress: %o",[n,...s]);let a=ne(),i=se(a),{port:p}=await ee({target:e,upstreamProxy:i,envVariables:a});pt.default.spawn(n,s,{stdio:"inherit",env:{...process.env,...ie(oe({port:p}),a)}}).on("exit",U=>{process.exit(U??1)})}async function lt(e,t){if(R("Cypress API URL: %s",e),R("Package version: %s",K.version),!e)throw new Error("Missing API URL");let r=require("cypress"),o={...process.env},n=ne(),s=se(n),{port:a,stop:i}=await ee({target:e,upstreamProxy:s,envVariables:n});try{return at(ie(oe({port:a}),n)),await r.run(t)}finally{process.env=o,await i()}}0&&(module.exports={getCypressCLIBinPath,run,spawn});
/*! For license information please see index.js.LEGAL.txt */
//# sourceMappingURL=index.js.map
